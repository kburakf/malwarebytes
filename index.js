require('dotenv').config();

const express = require('express');
const mongoDB = require('./app/modules/mongodb');
const bodyParser = require('body-parser');
const swaggerUi = require('swagger-ui-express');
const swaggerDocument = require('./app/config/swagger');
const rateLimit = require('express-rate-limit');

const { server, rateLimiter } = require('./app/config');
const app = express();

const apiLimiter = rateLimit({
  windowMs: rateLimiter.windowMs,
  max: rateLimiter.max,
  handler: (req, res) => {
    res.status(429).json({
      message: 'Too many requests, please try again later',
    });
  },
});

async function application() {
  try {
    await mongoDB.connect();

    app.use(bodyParser.json());

    // Global api rate limiter
    app.use(apiLimiter);

    app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerDocument));

    require('./app/routers/route-manager')(app);

    app.listen(server.port, () => {
      console.log(`Server is running on port ${server.port}`);
    });
  } catch (error) {
    console.error('Error during initial connection setup:', error);

    process.exit(1);
  }
}

application();
