const express = require('express');
const router = express.Router();

const fileController = require('../controllers/file');

const fileValidator = require('../middlewares/fileValidator');
const scanFileWithAntivirus = require('../middlewares/scanFileWithAntivirus');
const peFileValidator = require('../middlewares/peFileValidator');

router.post(
  '/',
  fileValidator,
  peFileValidator,
  scanFileWithAntivirus,
  fileController.uploadFile
);

router.use((err, _, res) => {
  // Handle Multer file size limit error
  if (err instanceof multer.MulterError && err.code === 'LIMIT_FILE_SIZE') {
    const maxSizeMB = server.maxFileSize / (1024 * 1024);

    return res
      .status(413)
      .send(
        `File too large. Please upload a file smaller than ${maxSizeMB}MB.`
      );
  }

  return res.status(500).send('Internal Server Error');
});

module.exports = router;
