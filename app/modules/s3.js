const AWS = require('aws-sdk');
const { s3 } = require('../config');

class S3Service {
  constructor() {
    this.s3 = new AWS.S3({
      endpoint: s3.endpoint,
      accessKeyId: s3.accessKey,
      secretAccessKey: s3.secretKey,
      s3ForcePathStyle: s3.s3ForcePathStyle,
      signatureVersion: s3.signatureVersion,
      region: s3.region,
    });

    this.bucket = s3.bucket;
  }

  async uploadFile({ name, contentType, buffer }) {
    const date = new Date();
    const year = date.getFullYear();
    const month = `${date.getMonth() + 1}`.padStart(2, '0'); // Adding 1 because getMonth() returns 0-11
    const day = `${date.getDate()}`.padStart(2, '0');

    const key = `${year}/${month}/${day}/${name}`;

    const params = {
      Bucket: this.bucket,
      Key: key,
      Body: buffer,
      ContentType: contentType,
    };

    return this.s3.upload(params).promise();
  }

  async deleteFile(key) {
    const params = {
      Bucket: this.bucket,
      Key: key,
    };
    return this.s3.deleteObject(params).promise();
  }
}

module.exports = S3Service;
