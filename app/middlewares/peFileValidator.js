const peFileValidator = async (req, res, next) => {
  if (!req.file) {
    return res.status(400).send('No file uploaded.');
  }

  try {
    const fileType = await import('file-type');

    // The file type is detected by checking the magic number of the buffer
    const file = await fileType.fileTypeFromBuffer(req.file.buffer);

    if (
      !file ||
      file.ext !== 'exe' ||
      file.mime !== 'application/x-msdownload'
    ) {
      return res.status(400).send('File is not a Portable Executable.');
    }

    req.peFile = {
      buffer: req.file.buffer,
      size: req.file.size,
      originalName: req.file.originalname,
      mimeType: file.mime,
    };

    next();
  } catch (error) {
    console.error(error);

    res.status(500).send('Internal Server Error');
  }
};

module.exports = peFileValidator;
