const { Readable } = require('stream');
const NodeClam = require('clamscan');

const { clamav } = require('../config');

const scanFileWithAntivirus = async (req, res, next) => {
  try {
    if (!req.file) {
      return res.status(400).send('No file uploaded.');
    }

    const fileStream = new Readable();
    fileStream.push(req.file.buffer);
    fileStream.push(null); // Signifies the end of the stream

    const clamscan = await new NodeClam().init({
      clamdscan: {
        host: clamav.host,
        port: parseInt(clamav.port),
      },
    });

    // Stream the file buffer to ClamAV for scanning
    const result = await clamscan.scanStream(fileStream);

    if (result.isInfected) {
      // We can save the log in database as well if it is needed
      return res
        .status(400)
        .send(`The file is infected with ${result.viruses}`);
    }

    next();
  } catch (error) {
    console.error('An error occurred while scanning the file:', error);

    return res.status(500).send('Internal Server Error');
  }
};

module.exports = scanFileWithAntivirus;
